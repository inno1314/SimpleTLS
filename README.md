# üîê –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å TLS handshake
–î–∞–Ω–Ω—ã–π –º–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç –±—ã–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä–∏ —Ä–µ—à–µ–Ω–∏–∏ CTF –∑–∞–¥–∞—á–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ [pwn.college](https://pwn.college/intro-to-cybersecurity/cryptography/) –∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –∏–∑ —Ä–∞–∑–¥–µ–ª–æ–≤ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –≤–µ–± –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- –æ–±–º–µ–Ω –∫–ª—é—á–∞–º–∏ Diffie‚ÄìHellman Key Exchange (DHKE)
- RSA –ø–æ–¥–ø–∏—Å—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- AES –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

–ó–∞–¥–∞—á–∞ (–∏ —Ü–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞) —Å–æ—Å—Ç–æ–∏—Ç –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤ TLS —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è.
## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è.
–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å–≤—è–∑–∏ –º–æ–∂–Ω–æ —Ä–∞–∑–±–∏—Ç—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã: –æ–±–º–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ `DHKE`, –ø–µ—Ä–µ–¥–∞—á–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ `RSA` —Å–∏–≥–Ω–∞—Ç—É—Ä, –≤–µ—Ä–µ—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ø–æ–¥–ø–∏—Å–∏, –æ–±–º–µ–Ω –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (`AES`).
–ü—Ä–æ–π–¥–µ–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É.
### 1. Diffie‚ÄìHellman Key Exchange
–ü–µ—Ä–≤–æ–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ ‚Äî —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á. –û–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∏–∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º DHKE –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å–≤—è–∑–∏.
1. –°—Ç–æ—Ä–æ–Ω—ã —Å–æ–≥–ª–∞—Å—É—é—Ç –¥–≤–∞ —á–∏—Å–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–≤–µ—Å—Ç–Ω—ã –≤—Å–µ–º: –±–æ–ª—å—à–æ–µ –ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ p –∏ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ g.
```python
p = int.from_bytes(
    bytes.fromhex(
        "FFFFFFFF FFFFFFFF C90FDAA2 2168C234 C4C6628B 80DC1CD1 "
        "29024E08 8A67CC74 020BBEA6 3B139B22 514A0879 8E3404DD "
        "EF9519B3 CD3A431B 302B0A6D F25F1437 4FE1356D 6D51C245 "
        "E485B576 625E7EC6 F44C42E9 A637ED6B 0BFF5CB6 F406B7ED "
        "EE386BFB 5A899FA5 AE9F2411 7C4B1FE6 49286651 ECE45B3D "
        "C2007CB8 A163BF05 98DA4836 1C55D39A 69163FA8 FD24CF5F "
        "83655D23 DCA3AD96 1C62F356 208552BB 9ED52907 7096966D "
        "670C354E 4ABC9804 F1746C08 CA18217C 32905E46 2E36CE3B "
        "E39E772C 180E8603 9B2783A2 EC07A28F B5C55DF0 6F4C52C9 "
        "DE2BCBF6 95581718 3995497C EA956AE5 15D22618 98FA0510 "
        "15728E5A 8AACAA68 FFFFFFFF FFFFFFFF"
    ),
    "big",
)
g = 2

show_hex("p", p)
show_hex("g", g)
```
2. –ö–∞–∂–¥–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω–æ —á–∏—Å–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–ª—å–∑—è –Ω–∏–∫–æ–º—É —Å–æ–æ–±—â–∞—Ç—å: `a = getrandbits(2048)`.
3. –°—Ç–æ—Ä–æ–Ω—ã —Å—á–∏—Ç–∞—é—Ç –æ—Ç–∫—Ä—ã—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ `A=g^a mod p` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥—Ä—É–≥ –¥—Ä—É–≥—É: `A = pow(g, a, p)`.
4. –ü–æ—Å–ª–µ –æ–±–º–µ–Ω–∞ —ç—Ç–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –∫–∞–∂–¥–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á: `s = B^a mod p = A^b mod p`.

–ë–ª–∞–≥–æ–¥–∞—Ä—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º–µ, –∏–∑–≤–µ—Å—Ç–Ω–æ–π –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–ø—Ä–æ–±–ª–µ–º–∞ –¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—Ä–æ–≤–∞–Ω–∏—è", —Ç—Ä–µ—Ç—å–∏ –ª–∏—Ü–∞ –Ω–µ —Å–º–æ–≥—É—Ç –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–µ–∫—Ä–µ—Ç, –¥–∞–∂–µ –∑–Ω–∞—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `A`, `B`, `p` –∏ `g`.
–ö–æ–≥–¥–∞ –æ–±–º–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω, —Å—Ç–æ—Ä–æ–Ω—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
### 2. RSA-–ø–æ–¥–ø–∏—Å–∏ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
–î–∞–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏: –∫–ª–∏–µ–Ω—Ç—É –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Ç–æ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç–æ—Ç, –∑–∞ –∫–æ–≥–æ —Å–µ–±—è –≤—ã–¥–∞–µ—Ç, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.
–í –¥–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ —Ä–æ–ª—å —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è –∏–≥—Ä–∞—é—Ç –ø—Ä–æ—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å –∫–ª—é—á–µ–º –∏ –∏–º–µ–Ω–µ–º, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é `RSA`:
- –£ –Ω–∞—Å –µ—Å—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π –∫–ª—é—á `root_key = RSA.generate(2048)`, –∫–æ—Ç–æ—Ä–æ–º—É —Å—Ç–æ—Ä–æ–Ω—ã –¥–æ–≤–µ—Ä—è—é—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ö–ª–∏–µ–Ω—Ç –∏ —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞—é—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å –∏–º–µ–Ω–µ–º –∏ –ø—É–±–ª–∏—á–Ω—ã–º –∫–ª—é—á–æ–º:
```python
root_certificate = {
    "name": "root",
    "key": {
        "e": root_key.e,
        "n": root_key.n,
    },
    "signer": "root",
}
```
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä–Ω–µ–≤—ã–º –∫–ª—é—á–æ–º:
```python
user_certificate = {
    "name": name,
    "key": {
        "e": user_key.e,
        "n": user_key.n,
    },
    "signer": "root",
}

user_certificate_data = json.dumps(user_certificate).encode()
user_certificate_hash = SHA256Hash(user_certificate_data).digest()
user_certificate_signature = pow(
    int.from_bytes(user_certificate_hash, "little"), root_d_value, root_key_n
).to_bytes(256, "little")
```
- –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏:
```python
user_signer_key = root_trusted_certificates[user_signer]["key"]
user_certificate_hash = SHA256Hash(user_certificate_data).digest()
user_certificate_check = pow(
    int.from_bytes(user_certificate_signature, "little"),
    user_signer_key["e"],
    user_signer_key["n"],
).to_bytes(256, "little")[: len(user_certificate_hash)]

if user_certificate_check != user_certificate_hash:
    print("Untrusted user certificate: invalid signature", file=sys.stderr)
    exit(1)
```
### 3. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–ª–∏–µ–Ω—Ç —Ç–∞–∫–∂–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–ª—è —Å–µ—Å—Å–∏–∏ –¥–∞–Ω–Ω—ã–µ (name + A + B), —á—Ç–æ–±—ã –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –æ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–ª–∞–¥–µ–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –∫–ª—é—á–æ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ—Ç–∫—Ä—ã—Ç–æ–º—É –∏–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:
```python
user_signature_data = (
    name.encode().ljust(256, b"\0")
    + A.to_bytes(256, "little")
    + B.to_bytes(256, "little")
)
user_signature_hash = SHA256Hash(user_signature_data).digest()
user_signature = pow(
    int.from_bytes(user_signature_hash, "little"), user_key.d, user_key.n
).to_bytes(256, "little")
```
–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞:
```python
user_signature_data = (
    name.encode().ljust(256, b"\0")
    + A.to_bytes(256, "little")
    + B.to_bytes(256, "little")
)
user_signature_hash = SHA256Hash(user_signature_data).digest()
user_signature_check = pow(
    int.from_bytes(user_signature, "little"), user_key["e"], user_key["n"]
).to_bytes(256, "little")[: len(user_signature_hash)]

if user_signature_check != user_signature_hash:
    print("Untrusted user: invalid signature", file=sys.stderr)
    exit(1)
```
–î–∞–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è –∑–∞—â–∏—Ç –æ—Ç –∞—Ç–∞–∫ —Ç–∏–ø–∞ MITM, –∏ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è—Ö –æ–Ω–∞ –≤—ã–≥–ª—è–¥–∏—Ç –≥–æ—Ä–∞–∑–¥–æ —Å–ª–æ–∂–Ω–µ–µ 
(—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –º–Ω–æ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –∏ –ø—Ä–æ–≤–µ—Ä–æ–∫, –≤–º–µ—Å—Ç–æ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ root –∫–ª—é—á–∞ –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–µ—Ä–∞—Ä—Ö–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ü–µ–Ω—Ç—Ä–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏,
–ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ —Å—Ö–µ–º—ã –ø–æ–¥–ø–∏—Å–∏ –∏ —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è). –í—Å–µ —É–ø—Ä–æ—â–µ–Ω–∏—è –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤.
### 4. –û–±–º–µ–Ω –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
–ö–æ–≥–¥–∞ —Å—Ç–æ—Ä–æ–Ω—ã —É–¥–æ—Å—Ç–æ–≤–µ—Ä–∏–ª–∏—Å—å –≤ —Ç–æ–º, —Å –∫–µ–º –æ–Ω–∏ –∫–æ–º–º—É–Ω–∏—Ü–∏—Ä—É—é—Ç, –∏ –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –æ–± –æ–±—â–µ–º —Å–µ–∫—Ä–µ—Ç–Ω–æ–º –∫–ª—é—á–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö.
–¢.–∫. –¥–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —Ä–µ—à–µ–Ω–∏–µ–º CTF –∑–∞–¥–∞—á–∏, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –Ω–∏ —á—Ç–æ –∏–Ω–æ–µ, –∫–∞–∫ —Ñ–ª–∞–≥:
```python
ciphertext = cipher_encrypt.encrypt(pad(flag.encode(), cipher_encrypt.block_size))
show_b64("secret ciphertext", ciphertext)
```
–ü—Ä–æ–≥—Ä–∞–º–º–∞, –∏–º–∏—Ç–∏—Ä—É—é—â–∞—è –∫–ª–∏–µ–Ω—Ç–∞, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –¥–∞–Ω–Ω—ã—Ö:
```python
p.recvuntil(b"secret ciphertext (b64): ")
ciphertext_b64 = p.recvline().strip().decode()
print(f"[DEBUG] secret ciphertext b64: {ciphertext_b64}")

ciphertext = base64.b64decode(ciphertext_b64)
flag = unpad(cipher_decrypt.decrypt(ciphertext), AES.block_size)
print(f"[+] FLAG: {flag.decode()}")
```
## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–î–∞–Ω–Ω–∞—è —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø–æ–Ω–∏–º–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ TLS –∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å —Ç–µ–º, –¥–ª—è —á–µ–≥–æ –Ω—É–∂–Ω—ã —Ç–µ –∏–ª–∏ –∏–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –æ–Ω–∏ —Ä–µ—à–∞—é—Ç.
–î–ª—è –∑–∞–ø—É—Å–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ:
```bash
git clone https://github.com/inno1314/SimpleTLS.git

cd SimpleTLS/
python3 -m venv .venv
source .venv/bin/activate
pip3 install -r requirements.txt

chmod +x ./server.py
python3 client.py
```

